# Что тут происходит?

* Сервис работает с датасетом Wine Quality. Сам файл лежит в `postgres/data.csv`. Первоисточник можно найти по [ссылке](https://archive.ics.uci.edu/ml/datasets/wine+Quality). Теперь мы не пользуемся воображением, а файл реально заезжает в postgresql при ините базы через compose! Лежит датасет теперь в `servicedb.public.dataset`.
* Параметры сервиса (а теперь это только креды к постгре) затягиваются из виртуального окружения:
  * `POSTGRES_HOST`
  * `POSTGRES_DB`
  * `POSTGRES_USER`
  * `POSTGRES_PASSWORD`
* У HTTP сервиса есть следующие методы:
  * POST /models/add:
    **Спавнит новую модель с указанными гиперпараметрами**<br>
    Подробное описание требований к входным данным есть в swagger в разделе model<br>
    Подробное описание ошибок также есть в swagger<br>
  * GET /models/list:
    **Возвращает json со списком запущенных моделей, статусом обучения и скором на Train и Test**<br>
    Параметры не обрабатывает<br>
    Подробное описание ошибок также есть в swagger<br>
  * POST /models/train:
    **Запускает обучение указанной в параметрах модели**<br>
    Подробное описание требований к входным данным есть в swagger в разделе model<br>
    Подробное описание ошибок также есть в swagger<br>
  * DELETE /models/remove:
    **Удаляет указанную в параметрах модель**<br>
    Подробное описание требований к входным данным есть в swagger в разделе model<br>
    Подробное описание ошибок также есть в swagger<br>
  * POST /models/predict:
    **Возвращает предсказание указанной в payload модели на указанных в payload входных данных**<br>
    Подробное описание требований к входным данным есть в swagger в разделе model<br>
    Подробное описание ошибок также есть в swagger<br>
* Те же методы реализованы и для gRPC. См. [proto-файл](https://github.com/mgcrp/hse_mlops_2022/blob/master/hw3/web_app/grpc/grpc.proto) с контрактом

# Как запустить HTTP из нового окружения?

1) Переходим в директорию hw3
2) Ставим зависимости - `poetry install`
3) Запускаем приложение - `poetry run python web_app/app.py`
4) Открываем swagger на 5000 порту и радуемся - http://127.0.0.1:5000
5) Можно баловаться в браузере

Реализация вне Docker использует параметры из `config.yaml`

# Как запустить gRPC из нового окружения?

1) Переходим в директорию hw3
2) Ставим зависимости - `poetry install`
3) Запускаем приложение - `poetry run python grpc_app/app.py`
4) Я заранее написал тесты, которые проверяют все методы. Для тестирования в новом терминале:
    * Переходим в директорию hw3
    * Запускаем тесты - `poetry run python tests/grpc_tests.py`

Реализация вне Docker использует параметры из `config.yaml`

# Реализация доведена до docker-compose
1) Переходим в директорию hw3
2) `docker-compose build`
3) `docker-compose up`
4) Синхронно работают оба интерфейса - и http (на 80 порту), и grpc (на 50051 порту)<br>
И теперь это точно REST :)

---

# Что тут сделано для 3 домашки?

1) В `models.py` добавил функцию `get_dataset_from_db()`, чтобы её можно было замокать
2) В `models.py` добавил обработчик в `Model.score()` для случаев, когда юзер пытается отскорить необученную модель
3) Unit-тесты для класса с моделью
    * Переходим в директорию hw3
    * Ставим зависимости - `poetry install`
    * Запускаем тесты - `poetry run pytest tests/ -v`
4) Data-тесты (см. в `models.py` функцию `check_data_quality()` + для ошибок с данными я добавил новый Exception - `ModelDataError`)
  * Добавил в `models.py` проверку на то, что приехал не пустой датасет
  * Добавил в `models.py` проверку на то, что в датасете нет null'ов
  * Добавил в `models.py` проверку на то, что в датасете есть все нужные признаки
  * P.S.: да, я знаю, что такое `assert` и как им пользоваться, но я хочу, чтобы оно допало мою кастомную ошибку `ModelDataError`
5) Интеграционные тесты
  * Для grpc - всё было и раньше, `grpc_test.py`, я об этом позаботился заранее :)
  * Для http - ей богу, мне лень. Транкейтнуть табличку, вызвать из файла несколько `requests.get`, `requests.post`, `requests.delete` в порядке, как в grpc и ассертнуть, что вывод соответствует ожиданиям... Это не сложно (особенно по сравнению с "разобраться в pytest") - но муторно. Времени на это особо нет, да и желания тоже, честно говоря...
